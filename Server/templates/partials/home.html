{% extends "layout.html" %}
{% block content %}
    <style type="text/css">
    </style>

    <div id="home">

        <div class="grid-y grid-padding-y full">
            <div class="cell small-2 medium-3">
                <h1 style="padding: 20px">你好，{{ user }}！</h1>
            </div>

            <div class="cell small-10 medium-9 small-cell-block-y" style="overflow: auto;">
                <ul class="tabs" id="home-tabs">
                    <li class="tabs-title" v-bind:class="{ 'is-active': tab==1 }"><a v-on:click="tab_change(1)" v-bind:aria-selected="tab_selected(1)">追读中</a></li>
                    <li class="tabs-title" v-bind:class="{ 'is-active': tab==1 }"><a v-on:click="tab_change(2)" v-bind:aria-selected="tab_selected(2)">库存</a></li>
                </ul>

                <div class="tabs-content" data-tabs-content="home-tabs">
                    <div class="tabs-panel" v-bind:class="{ 'is-active': tab==1 }" id="reading">
                        <div v-if="!books.length">
                            <h1>请先添加待追读的小说！</h1>
                        </div>
                        <div class="book-list" v-for="book in books" v-bind:key="book.book" v-if="books.length">
                            <div class="callout secondary small">
                                <div class="grid-x">
                                    <h4 class="cell shrink" v-on:click="read(book.book)"><span class="badge" v-bind:class="{ 'primary': book.remains >0, 'secondary': book.remains < 1 }">!{ book.remains }</span>&nbsp;!{ book.book }</h4>
                                    <div class="cell auto" v-on:click="read(book.book)"></div>
                                    <button class="cell shrink" type="button" v-if="book.show" v-on:click="remove(book.book)" aria-label="Dismiss alert">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <p class="book-chapter" v-on:click="read(book.book)">!{ book.chapter }</p>
                            </div>
                        </div>
                    </div>
                    <div class="tabs-panel" v-bind:class="{ 'is-active': tab==2 }" id="pending">
                        <div v-if="!pending.length">
                            <h1>已经没有未追读的小说了！</h1>
                        </div>
                        <div class="book-lists" v-for="book in pending" v-bind:key="book.book" v-if="pending.length">
                            <div class="callout small">
                                <div class="grid-x" v-on:click="read(book.book)">
                                    <h4 class="cell shrink">!{ book.book }</h4>
                                    <div class="cell auto"></div>
                                    <button class="cell shrink" type="button" v-if="book.show" v-on:click="add(book.book)" aria-label="Dismiss success">
                                        <span class="large" aria-hidden="true">&hearts;</span>
                                    </button>
                                </div>
                                <p class="book-chapter">!{ book.chapter }</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>

//import VueResource from 'vue-resource'

Vue.use(VueResource);
Vue.http.headers.common["X-CSRFToken"] = "{{ csrf_token() }}";

function init_book(value) {
    let sub_strs = value.split("_");
    if(sub_strs.length === 3)
        return {book: sub_strs[0], chapter: sub_strs[1] + " " + sub_strs[2], show:true};
    else
        return {book: sub_strs[0], chapter: sub_strs[1] + " " + sub_strs[2], page: sub_strs[3],
            remains: sub_strs[4], show: true};
}

function set_invisible(elem, book_name) {
    if(elem.book === book_name){
        elem.show = false
    }
    return elem;
}


function compare(a, b){
    if (a.remains < b.remains){
        return 1;
    }else if (a.remains > b.remains){
        return -1;
    }else return 0;
}

var app = new Vue({
    el: "#home",
    data: {
{% if books|length > 0 %}
        books: function () {
            const ori = ["{{ books|join("\", \""|safe) }}"];
            return ori.map(init_book).sort(compare)
        }(),
{% else %}
        books: [],
{% endif %}
{% if pending|length > 0 %}
        pending: function () {
            const ori = ["{{ pending|join("\", \""|safe) }}"];
            return ori.map(init_book)
        }(),
{% else %}
        pending: [],
{% endif %}
        tab: 1,
        according: {
            books: null,
            pending: null
        }
    },
    methods: {
        add: function (book_name) {
            this.pending = this.pending.map(book => set_invisible(book, book_name));
            this.$http.post('/book/add', {book: book_name}, {emulateJSON: true}).then(
                function(res){
                    this.pending = this.pending.filter(each => each.book !== book_name);
                    this.books.unshift(init_book(res.body.book));
                    this.according.books = this.books[0].book;
                },
                function (res){
                    console.log(res);
                    window.location.reload();
                });
        },
        remove: function (book_name) {
            this.books = this.books.map(book => set_invisible(book, book_name));
            this.$http.post('/book/remove', {book: book_name}, {emulateJSON: true}).then(
                function (res) {
                    this.books = this.books.filter(each => each.book !== book_name);
                    this.pending.push(init_book(res.body.book));
                    this.according.pending = this.pending[0].book;
                },
                function (res) {
                    console.log(res);
                    window.location.reload();
                }
            );
        },
        read: function (book_page) {
            window.location.href = "/read/" + book_page;
        },
        tab_change: function (value) {
            this.tab = value;
        },
        tab_selected: function (tab) {
            return tab === this.tab;
        },
        pending_set_active: function (name) {
            this.according.pending = name;
        },
        books_set_active: function (name) {
            this.according.books = name;
        },
        pending_active: function (name) {
            return name === this.according.pending;
        },
        books_active: function (name) {
            return name === this.according.books;
        },
    },
    delimiters: ['!{','}']
});
</script>
{% endblock %}